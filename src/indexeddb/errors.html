<html>
<body>
  <div id='log'></div>

  <script>

    var log = function (msg) {
			document.getElementById("log").innerHTML += msg + "<br/>";
			console.log(msg);
		};

    var o2s = function(o) {
      var res = '';
      for(var p in o) {
        res += p + ':' + o[p] + ';';
      }
      return res;
    };

    var init = function(version) {
      var currentVersion;
      var request;
      var db;

      if(typeof version !== 'number') {
        log('open without version');
        request = window.indexedDB.open('mydb');
      } else {
        log('open with version: ' + version);
        request = window.indexedDB.open('mydb', version);
      }

			// We can only create Object stores in a versionchange transaction.
			request.onupgradeneeded = function(e) {
				log('onupgradeneeded');

				db = e.target.result;

        db.onabort = function(e) {
          log('onabort:'+o2s(e.target.error));
        };

				// A versionchange transaction is started automatically.
				e.target.transaction.onerror = function(e) {
  				log('transaction.onerror:' + o2s(e.target.error) + ':' + (typeof version === 'number') );
  			};

				if(db.objectStoreNames.contains('mystore')) {
					log('onupgradeneeded: table exists. deleting it');
					db.deleteObjectStore('mystore');
				}

        if(typeof version === 'number') {
          log('onupgradeneeded: creating store');
				   db.createObjectStore('mystore', {keyPath: 'key_path'});
           //log('onupgradeneeded: creating same store again');
 				   //db.createObjectStore('mystore', {keyPath: 'key_path'});
        }
			};

			request.onsuccess = function(e) {
				log('onsuccess');
				db = e.target.result;
        currentVersion = db.version;

        if(typeof version !== 'number') {
          db.close();
          setTimeout(function() {init(currentVersion+1)}, 2000);
        }
			};

      request.onblocked = function(e) {
        log('onblocked:' + o2s(e));
      };

			request.onerror = function(e) {
				log('onerror:' + o2s(e.target.error) + ':' + (typeof version === 'number') );
			};
    };

    // Start things when the DOM is loaded
    window.addEventListener('DOMContentLoaded', init, false);

  </script>
</body>
</html>
